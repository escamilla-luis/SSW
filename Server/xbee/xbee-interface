var util = require('util');
var SerialPort = require('serialport');
var xbee_api = require('xbee-api');
var C = xbee_api.constants;


// Path to serialport may be different on different machines
var pathToPort = '/dev/tty.usbserial-DN01J8BJ';
var port = new SerialPort(pathToPort, {
    autoOpen: false,
    baudrate: 57600
});

/*** --= XBEE FUNCTIONS =-- ***/

function writeToXbee(value, callback) {
    port.on('open', function() {
        port.on('data', function (fromXbee) {
            
            if (callback) {
                // Handle data from xbee
                console.log('Data received: ' + fromXbee);
                callback(fromXbee);
            }
            
            port.close();
        });
        
        console.log('Writing value to xbee');
        port.write(value);
    });
    
    port.open(function (err) {
        if (err) {
            console.log('Error opening port: ', err.message);
            console.log('Retrying to open port...');
            setTimeout(function() {
                writeToXbee(value);
            }, 1000);
        } else {
            console.log('Port opened');
        }
    });
}

writeToXbee('33');